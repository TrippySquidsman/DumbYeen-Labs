#
# Author: Mike Rushton
#
# IMPORTANT
#
# Please set jail.local's permission to 640 because it contains your CF API key.
#
# This action depends on curl (and optionally jq).
# Referenced from http://www.normyee.net/blog/2012/02/02/adding-cloudflare-support-to-fail2ban by NORM YEE
#
# To get your CloudFlare API Key: https://www.cloudflare.com/a/account/my-account
#
# CloudFlare API error codes: https://www.cloudflare.com/docs/host-api.html#s4.2

[Definition]

actionban = curl -X POST "https://api.cloudflare.com/client/v4/zones/<_cf_zone_id>/firewall/access_rules/rules" \
            -H "Authorization: Bearer <_cf_api_token>" \
            -H "Content-Type: application/json" \
            --data '{
              "mode": "block",
              "configuration": {
                 "target": "ip",
                 "value": "<ip>"
              },
            "notes": "brute-force attack on vaultwarden"
            }'
	bash /etc/fail2ban/action.d/telegram_notif.sh -b <ip> -c "..." -t "..." -r "a brute-force attack for '<F-USER>' on vaultwarden [ban count: <bancount>]"
           

actionunban = bash /etc/fail2ban/action.d/action-unban-cloudflare.sh <ip> <_cf_api_email> <_cf_api_key> <_cf_api_token> <_cf_zone_id>


[Init]

_cf_api_email = ...
_cf_zone_id = ...
_cf_api_url = https://api.cloudflare.com/client/v4/user/firewall/access_rules/rules
_cf_api_key = ...
_cf_api_token = ...
_cf_api_prms = -H 'X-Auth-Email: _cf_api_email' -H 'X-Auth-Key: _cf_api_key' -H 'Content-Type: application/json'

cftarget = ip

[Init?family=inet6]

cftarget = ip6
